%# -*- coding: utf-8 -*-
%!TEX encoding = UTF-8 Unicode
%!TEX TS-program = xelatex
% 以上设定默认使用 XeLaTex 编译，并指定 Unicode 编码，供 TeXShop 自动识别

% 使用 LaTex 写中文的配置模板
%\documentclass[12pt]{article}

%\newcommand{\doctitle}{Peer-to-Peer Communication Across Network Address Translators}
%\newcommand{\doctitle}{穿越NAT的点对点通信}
%\newcommand{\docauthor}{Bryan Ford \& Pyda Srisuresh \& Dan Kegel}
%\newcommand{\dockeywords}{NAT穿越, 点对点, NAT Traversal, Peer-to-Peer}
%\newcommand{\docsubject}{NAT穿越}

\newcommand\mymainfont{Times New Roman}
\newcommand\mymonofont{AR PL UMing CN}%{WenQuanYi Micro Hei Mono}%{FreeMono} %{Monaco}
\newcommand\myboldfont{WenQuanYi Micro Hei Mono}%{AR PL UKai CN}%{YaHei Consolas Hybrid}%{黑体}%{標楷體}
\newcommand\mycjkmainfont{AR PL UMing CN}%{仿宋}%{宋体}%{新宋体}%{文鼎ＰＬ新宋}%
\newcommand\mycjkmonofont{AR PL UMing CN}%{WenQuanYi Micro Hei Mono}
\newcommand\mycjkboldfont{WenQuanYi Micro Hei Mono}%{AR PL UKai CN}%{YaHei Consolas Hybrid}%{黑体}%{標楷體}
\newcommand\mysansfont{FreeSans}
\newcommand\myitalicfont{Times New Roman}
\newcommand\myenglishfont{WenQuanYi Micro Hei Mono}%{FreeMono} %{Garamond}

% the algorithm2e package
\makeatletter
\newif\if@restonecol
\makeatother
\let\algorithm\relax
\let\endalgorithm\relax
\usepackage[ruled,vlined]{algorithm2e} %\usepackage[figure,ruled,vlined]{algorithm2e}

%\usepackage[margin=1.0cm,nohead]{geometry}
%\usepackage[top=1in,bottom=1in,left=1.25in,right=1.25in]{geometry} % 设置页边距
%\setlength{\belowcaptionskip}{1em} % 设置caption之后的距离

\usepackage{ifthen}
\usepackage{ifpdf}
\usepackage{ifxetex}
\usepackage{ifluatex}

\ifxetex % xelatex
\else
    %The cmap package is intended to make the PDF files generated by pdflatex "searchable and copyable" in acrobat reader and other compliant PDF viewers.
    \usepackage{cmap}%
\fi

\usepackage{url}
\usepackage{array}
\usepackage{color}
\usepackage{courier}
\usepackage{listings} % list the source code
\definecolor{ForestGreen}{rgb}{0.13,0.55,0.13}

\lstset{
    language=C,
    captionpos=b,
    tabsize=2,
    frame=lines,
    basicstyle= \normalfont\ttfamily, % \large\ttfamily, % \small\ttfamily, % \footnotesize\ttfamily, % \scriptsize\ttfamily, % Standardschrift,
    keywordstyle=\color{blue},
    commentstyle=\color{ForestGreen},
    stringstyle=\color{red},
    numbers=left,
    numberstyle=\tiny,
    numbersep=5pt,
    breaklines=true,
    showstringspaces=false,
    emph={label}
}

\definecolor{darkgreen}{cmyk}{0.7, 0, 1, 0.5}
\definecolor{darkblue}{rgb}{0.1, 0.1, 0.5}
\lstdefinelanguage{diff}
{
    keywords={+, -, \ , @@, diff, index, new},
    sensitive=false,
    morecomment=[l][""]{\ },
    morecomment=[l][\color{darkgreen}]{+},
    morecomment=[l][\color{red}]{-},
    morecomment=[l][\color{darkblue}]{@@},
    morecomment=[l][\color{darkblue}]{diff},
    morecomment=[l][\color{darkblue}]{index},
    morecomment=[l][\color{darkblue}]{new},
    morecomment=[l][\color{darkblue}]{similarity},
    morecomment=[l][\color{darkblue}]{rename},
}

\usepackage{tabularx} % long table
\usepackage{booktabs,longtable} % table in seperate pages.

% ============================================
% Check for PDFLaTeX/LaTeX
% ============================================
\newif\ifpdf
\ifx\pdfoutput\undefined
  \pdffalse % we are not running PDFLaTeX

  \usepackage[dvipdfmx,
        bookmarksnumbered, %dvipdfmx
        %% unicode, %% 不能有unicode选项，否则bookmark会是乱码
        colorlinks=true,
        urlcolor=blue,        % \href{...}{...} external (URL)
        filecolor=red,      % \href{...} local file
        linkcolor=black, % \ref{...} and \pageref{...}
        citecolor=red,
        breaklinks,
        pdftitle={\doctitle},
        pdfauthor={\docauthor},
        pdfsubject={\docsubject},
        pdfkeywords={\dockeywords},
        pdfproducer={Latex with hyperref},
        pdfcreator={pdflatex}
        %%pdfadjustspacing=1,
        pdfborder=1,
        pdfpagemode=UseNone,
        pagebackref,
        bookmarksopen=true]{hyperref}

\else
  \pdfoutput=1 % we are running PDFLaTeX
  \pdftrue

  \usepackage{thumbpdf}
  \usepackage[pdftex,
        bookmarksnumbered, %dvipdfmx
        %% unicode, %% 不能有unicode选项，否则bookmark会是乱码
        colorlinks=true,
        urlcolor=blue,        % \href{...}{...} external (URL)
        filecolor=red,      % \href{...} local file
        linkcolor=black, % \ref{...} and \pageref{...}
        citecolor=red,
        breaklinks,
        pdftitle={\doctitle},
        pdfauthor={\docauthor},
        pdfsubject={\docsubject},
        pdfkeywords={\dockeywords},
        pdfproducer={Latex with hyperref},
        pdfcreator={pdflatex}
        %%pdfadjustspacing=1,
        pdfborder=1,
        pdfpagemode=UseNone,
        pagebackref,
        bookmarksopen=true]{hyperref}

\fi

% --------------------------------------------
% Load graphicx package with pdf if needed 
% --------------------------------------------
\ifxetex    % xelatex
    %% chinese setup
    %\usepackage{xeCJK}
    \usepackage[BoldFont, % 允许粗体
        SlantFont,        % 允许斜体
        CJKsetspaces,
        CJKchecksingle]{xeCJK}
    \defaultfontfeatures{Mapping=tex-text} %如果没有它，会有一些 tex 特殊字符无法正常使用，比如连字符。

    \XeTeXlinebreaklocale "zh"                      % 重要，使得中文可以正确断行！
    \XeTeXlinebreakskip = 0pt plus 1pt minus 0.1pt  %

    \setCJKmainfont[BoldFont=\mycjkboldfont]{\mycjkmainfont}
    \setCJKmonofont{\mycjkmonofont}

    %\setmainfont{\mymainfont}        % 英文衬线字体, setmainfont=setromanfont
    %\setromanfont[Mapping=tex-text,  % 沿用 LaTex 的一些习惯的标点转换，例如 en-dash 以两个减号表示
        %Ligatures={Required,Common}, % 如果此字体内置 Ligatures 定义则启用
        %ItalicFont={\myitalicfont},  % 斜体用 Times Italic，严格来说只有拉丁子母有斜体。
        %BoldFont={\myboldfont}]      % 粗体用字体
        %{\mymainfont}                % 内文使用字体, Linux 下用 "fc-list :lang=zh-cn" 列出支持的中文字体
    %\setmonofont[Scale=0.8]{\mymonofont} % 英文等宽字体
    %\setsansfont{\mysansfont}       % 英文无衬线字体

    %\newfontfamily{\j}{Osaka}       % 设置特殊字符，这里是为日文准备的特殊字体。没有该字体，所以关闭。

    %\newfontinstance\rmfont{\myenglishfont} % 定义 rmfont 的快捷命令，可以用于在中文中显示指定的其他英文字体
    %\newcommand{\nc}[1]{{\rmfont #1}} % 如果，在中、英文夾雜時，英文想用不同的字型，則可以使用開頭時定義的 nc 指令 \nc{This is Times font.  The ‘field’ contains ligatures.}。可以比较在外面的英文字体：This is Times font.  The ‘field’ contains ligatures. 在大括号内局部设置字体：{\fontspec{Hei} (fontspec 用法和前面預設字形之 setromanfont 一樣，只是可更自由地使用)這是用日文字形的測試。只要打正常中文即可。可能會缺字就是了。}

    \usepackage[cm-default]{fontspec} % XeLaTex 配合 fontspec 可以非常方便地设置字体。[cm-default]选项主要用来解决使用数学环境时数学符号不能正常显示的问题
    %\usepackage{xltxtra,xunicode} %这行和上行 \usepackage[cm-default]{fontspec} 解决公式不正常的问题.但是打开后有些如 itemize 的点不能显示。

    \setlength{\parindent}{2.04em}  %设置首行缩进。只有中文才打开。
    \linespread{1.3}                % 设置行距

    %\definecolor{bisque}{rgb}{.996,.891,.755}
    %\pagecolor{bisque} % 设置背景颜色

    % 设置原文照排环境的字体
    % \makeatletter
    % \def\verbatim@font{\sffamily\small}
    % \makeatother

    % 将默认的英文重定义为中文
    \renewcommand{\contentsname}{目录}
    \renewcommand{\listfigurename}{插图目录}
    \renewcommand{\listtablename}{表格目录}
    %\renewcommand{\abstractname}{摘要}
    \renewcommand{\indexname}{索引}
    \renewcommand{\tablename}{表}
    \renewcommand{\figurename}{图}
    \renewcommand{\appendixname}{附录}
    %\renewcommand{\chaptername}{章节}
    %\renewcommand{\refname}{参考文献}
    %\renewcommand{\bibname}{参考}
    %\renewcommand{\IEEEkeywordsname}{关键词}

    % 设置页眉页脚
    %\usepackage[pagestyles,compact]{titlesec} % 定制页眉页脚
    %\newpagestyle{main}{%
        %\sethead[$\cdot$~\thepage~$\cdot$][][\thesection\quad%
        %\sectiontitle]{\thesection\quad\sectiontitle}{}{%
            %$\cdot$~\thepage~$\cdot$}
        %\setfoot{}{}{}\headrule}
        %\pagestyle{main}
        %\renewpagestyle{plain}{\sethead{}{}{}\setfoot{}{}{}}
    %\pagestyle{plain}

    % 设置chapter, section与subsection的格式
    %\titleformat{\chapter}{\centering\huge}{\textbf{第\thechapter{}章}}{1em}{\textbf}
    %\titleformat{\section}{\centering\LARGE}{\textbf{\thesection}}{1em}{\textbf}
    %\titleformat{\subsection}{\Large}{\textbf{\thesubsection}}{1em}{\textbf}

    % For LaN
    \newcommand{\LaN}{L{\scriptsize\hspace{-0.47em}\raisebox{0.23em}{A}}\hspace{-0.1em}N}

    % 去掉表头中的冒号
    \makeatletter
        \long\def\@makecaption#1#2{%
            \vskip\abovecaptionskip
            \sbox\@tempboxa{#1~~#2}%
            \ifdim \wd\@tempboxa >\hsize
                #1~~#2\par
            \else
                \global \@minipagefalse
                \hb@xt@\hsize{\hfil\box\@tempboxa\hfil}%
            \fi
            \vskip\belowcaptionskip}
    \makeatother

    % XeTeX logo
    \def\XeTeX{\leavevmode
        \setbox0=\hbox{X\lower.5ex\hbox{\kern-.15em\reflectbox{E}}\kern-.1667em \TeX}%
        \dp0=0pt\ht0=0pt\box0}

    \usepackage{graphicx}
\else
    \ifpdf
        \usepackage[pdftex]{graphicx}
        \pdfcompresslevel=9
    \else
        \usepackage{graphicx} % \usepackage[dvipdfm]{graphicx}
    \fi
\fi
%% \DeclareGraphicsRule{.jpg}{eps}{.bb}{}
%% \DeclareGraphicsRule{.png}{eps}{.bb}{}
\graphicspath{{./} {figures/}}
\usepackage{flafter} % 防止图形在文字前

%%%% 字体：
%Adobe Heiti Std 和 Adobe Song Std是砖头公司出的两款超pp的字体，有人把它们用在latex排版中，效果超级好。
%windows版在 Program Files/Adobe/Acrobat 8.0/Resource/CIDFont 下。

%sudo mkdir /usr/share/fonts/adobe
%sudo cp DIR2adobefonts/*.otf /usr/share/fonts/adobe
%sudo chmod 644 /usr/share/fonts/adobe/*.otf # 当前用户读写，当前组用户读写，其他用户只读

%cd /usr/share/fonts/adobe/
%sudo mkfontscale #（创建fonts.scale文件，控制字体旋转缩放）
%sudo mkfontdir #（创建fonts.dir文件，控制字体粗斜体产生）
%sudo fc-cache -fv # (建立字体缓存信息，也就是让系统认识认识）
%fc-list :lang=zh-cn # 看看装上没


%安装 LaTeX+XeTeX环境的过程, 你也使用Emacs来编辑TeX文件的话, 那么一定要安上AUCTeX这个扩展
%sudo apt-get install texlive texlive-latex-extra texlive-xetex lmodern # 首先是LaTeX与XeTeX的安装

%sudo apt-get install auctex

%安装好以后, 重点是配置.emacs文件, 因为AUCTeX本身是不支持通过xelatex编译的.
%;; AUCTeX
%(defun auctex ()
  %(add-to-list 'TeX-command-list '("XeLaTeX" "%`xelatex%(mode)%' %t; %`xelatex%(mode)%' %t" TeX-run-TeX nil t)) ;; 这里我编译了两次
    %(setq TeX-command-default "XeLaTeX") ;; 设定默认编译命令为XeLaTeX
    %(setq TeX-save-query nil)            ;; 保存之前不询问
    %(setq TeX-show-compilation t))       ;; 在新窗口显示编译过程
%(add-hook 'LaTeX-mode-hook 'auctex)

%(custom-set-variables
 %'(TeX-output-view-style (quote (("^dvi$nnnnnnn" ("^landscape$" "^pstricks$\\|^pst-\\|^psfrag$") "%(o?)dvips -t landscape %d -o && gv %f") ("^dvi$" "^pstricks$\\|^pst-\\|^psfrag$" "%(o?)dvips %d -o && gv %f") ("^dvi$" ("^a4\\(?:dutch\\|paper\\|wide\\)\\|sem-a4$" "^landscape$") "%(o?)xdvi %dS -paper a4r -s 0 %d") ("^dvi$" "^a4\\(?:dutch\\|paper\\|wide\\)\\|sem-a4$" "%(o?)xdvi %dS -paper a4 %d") ("^dvi$" ("^a5\\(?:comb\\|paper\\)$" "^landscape$") "%(o?)xdvi %dS -paper a5r -s 0 %d") ("^dvi$" "^a5\\(?:comb\\|paper\\)$" "%(o?)xdvi %dS -paper a5 %d") ("^dvi$" "^b5paper$" "%(o?)xdvi %dS -paper b5 %d") ("^dvi$" "^letterpaper$" "%(o?)xdvi %dS -paper us %d") ("^dvi$" "^legalpaper$" "%(o?)xdvi %dS -paper legal %d") ("^dvi$" "^executivepaper$" "%(o?)xdvi %dS -paper 7.25x10.5in %d") ("^dvi$" "." "%(o?)xdvi %dS %d") ("^pdf$" "." "acroread %o %(outpage)") ("^html?$" "." "netscape %o")))))

%最后那个有点长, 主要是没有找到合适的方法像添加XeLaTeX一样只需要写新增的条目, 所以这里就把原有的和修改以后的都写了出来. 其实只改了一个地方, 已经用蓝色标注出来了, 就是在使用C-c C-v预览PDF文件的时候使用什么软件来打开. 我这里就是acroread, 你用的其它的话, 可以相应修改.
%这样修改好以后, 以后就可以直接使用C-c C-c编译, C-c C-v预览, C-c `在错误间跳转了.

%但是TeX Live中的install-info文件会导致源安装AUCTeX的时候失败, 所以如果是先安装的TeX Live, 再安装AUCTeX, 就需要先把TeX Live的install-info"消灭"掉: 
%sudo mv /usr/local/bin/install-info /usr/local/bin/install-info.bak

%-------------------------------------------------------------------
%终于搞定在emacs+auctex中设置xelatex为默认编译命令！

%只要在在~/.emacs中加上

%(add-hook 'LaTeX-mode-hook (lambda()
    %(add-to-list 'TeX-command-list '("XeLaTeX" "%`xelatex%(mode)%' %t" TeX-run-TeX nil t))
    %(setq TeX-command-default "XeLaTeX")
    %(setq TeX-save-query  nil )
    %(setq TeX-show-compilation t)
    %))

%第一行参考auctex的手册auctex.pdf,版本是11.84 ；
%(add-to-list 'TeX-command-list '("XeLaTeX" "%`xelatex%(mode)%' %t" TeX-run-TeX nil t)) 会在Command 这一栏中增加了XeLaTeX这一项命令；
%(setq TeX-command-default "XeLaTeX")  则使得以后用C-c C-c就是默认用xelatex 命令编译tex文档；
%(setq TeX-save-query  nil ) 这一行不用确认保存就开始执行编译；
%(setq TeX-show-compilation t)  这一行是看到编译的滚动信息。
%现在还是在latex-mode下配置，下一步看能否在pdflatex-mode 下配置。


%(add-to-list 'TeX-command-list '("XeLaTeX" "%`xelatex%(mode)%' %t" TeX-run-TeX nil t)) 这一行中的"%`xelatex%(mode)%' %t"
%写成"xelatex  %t" 已经可以了。
